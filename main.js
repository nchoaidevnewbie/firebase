let isProcessing = false;
   
       
// C·∫•u h√¨nh Firebase
const firebaseConfig = {
apiKey: "AIzaSyCstVjJU-Ux0JZbeAcWY4y7l5q9cfDJCDg",
authDomain: "menukoder2.firebaseapp.com",
databaseURL: "https://menukoder2-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "menukoder2",
storageBucket: "menukoder2.firebasestorage.app",
messagingSenderId: "820376638525",
appId: "1:820376638525:web:aeb36e5c1f5184ffbb4654",
};

// Kh·ªüi t·∫°o Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database(); 
// th√¥ng b√°o
function closeNotification() {
     document.getElementById("notificationBox").style.display = "none";
 }

 // H√†m hi·ªÉn th·ªã th√¥ng b√°o
 function displayNotification(message) {
     const notificationBox = document.getElementById("notificationBox");
     const notificationMessage = document.getElementById("notificationMessage");

     notificationMessage.innerHTML = message;
     notificationBox.style.display = "block";
 }

 // L·∫Øng nghe th√¥ng b√°o t·ª´ Firebase
 function listenForNotifications() {
     db.ref("notifications").on("child_added", (snapshot) => {
         const notification = snapshot.val();
         console.log("Th√¥ng b√°o nh·∫≠n ƒë∆∞·ª£c:", notification);

         // Hi·ªÉn th·ªã th√¥ng b√°o
         displayNotification(notification.message);
     });
 }

 // Kh·ªüi ƒë·ªông vi·ªác l·∫Øng nghe th√¥ng b√°o khi trang ƒë∆∞·ª£c t·∫£i
 listenForNotifications(); 


function checkMaintenance() {
db.ref("/maintenance").on("value", (snapshot) => {
 const isMaintenance = snapshot.val();
 const content = document.getElementById("content");
 const maintenanceMessage = document.getElementById("maintenanceMessage");

 if (isMaintenance) {
     content.style.display = "none"; 
     maintenanceMessage.style.display = "block";

     // L·∫•y n·ªôi dung th√¥ng b√°o b·∫£o tr√¨ t·ª´ Firebase
     db.ref("/maintenanceMessage").once("value").then((messageSnapshot) => {
         const maintenanceText = messageSnapshot.val();
         if (maintenanceText) {
             maintenanceMessage.innerHTML = maintenanceText; // C·∫≠p nh·∫≠t n·ªôi dung t·ª´ server
         } else {
             maintenanceMessage.innerHTML = "H·ªá th·ªëng ƒëang b·∫£o tr√¨, vui l√≤ng quay l·∫°i sau!";
         }
     }).catch((error) => {
         console.error("L·ªói t·∫£i n·ªôi dung b·∫£o tr√¨:", error);
         maintenanceMessage.innerHTML = "H·ªá th·ªëng ƒëang b·∫£o tr√¨, vui l√≤ng quay l·∫°i sau!";
     });

 } else {
     content.style.display = "block"; 
     maintenanceMessage.style.display = "none"; 
 }
});
}

checkMaintenance(); 

function verifyKey() {
const inputKey = document.getElementById("keyInput").value.trim();
const now = new Date();
const keyRef = db.ref("daily_key");

keyRef.once("value")
 .then((snapshot) => {
     const keyData = snapshot.val();
     if (!keyData) {
         alert("üö´ Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu key!");
         return;
     }

     let isValid = false;

     for (let keyID in keyData) {
         let keyInfo = keyData[keyID];

         if (!keyInfo.key || !keyInfo.startDate || !keyInfo.endDate) continue; 

         const start = new Date(keyInfo.startDate);
         const end = new Date(keyInfo.endDate);

         if (inputKey === keyInfo.key) {
             if (now < start) {
                 alert("‚è≥ Key ch∆∞a t·ªõi ng√†y k√≠ch ho·∫°t!");
                 return;
             }
             if (now > end) {
                 alert("‚ùå Key ƒë√£ h·∫øt h·∫°n!");
                 return;
             }

             isValid = true;
             break;
         }
     }

     if (isValid) {
         alert("‚úÖ Key ch√≠nh x√°c! ƒêang truy c·∫≠p menu...");
         // C·∫≠p nh·∫≠t l∆∞·ª£t ƒëƒÉng nh·∫≠p v√†o Firebase
         function updateKeyUsage() {
const dbRef = db.ref("key_log");
const now = new Date();

// ƒê·ªãnh d·∫°ng ng√†y, tu·∫ßn v√† th√°ng
const dailyKey = now.toISOString().split("T")[0]; // YYYY-MM-DD
const weeklyKey = `${now.getFullYear()}-${Math.ceil((now.getDate() + new Date(now.getFullYear(), now.getMonth(), 1).getDay()) / 7)}`; // YYYY-WW
const monthlyKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM

// H√†m c·∫≠p nh·∫≠t gi√° tr·ªã trong Firebase
function incrementCount(refPath) {
 db.ref(refPath).transaction((count) => (count || 0) + 1);
}

// C·∫≠p nh·∫≠t d·ªØ li·ªáu
incrementCount(`key_log/daily/${dailyKey}`);
incrementCount(`key_log/weekly/${weeklyKey}`);
incrementCount(`key_log/monthly/${monthlyKey}`);
}


// G·ªçi h√†m n√†y khi key nh·∫≠p th√†nh c√¥ng
updateKeyUsage();

         document.getElementById("menu").style.display = "block";
         document.getElementById("keyInput").style.display = "none";
         document.getElementById("verifyBtn").style.display = "none";
         document.getElementById("titlekey").style.display = "none";
         document.getElementById("newtitle").style.display = "none";
         document.getElementById("getkey").style.display = "none";
         document.getElementById("footerby").style.display = "none";
         document.getElementById("mxhkey").style.display = "none";
         document.getElementById("hrmxh").style.display = "none";
         document.getElementById("grkey").style.display = "none";
         document.getElementById("ytbkey").style.display = "none";
         document.getElementById("shopkey").style.display = "none";
     } else {
         alert("‚ùå Sai key r·ªìi bro!");
     }
 })
 .catch((error) => {
     console.error("L·ªói truy v·∫•n Firebase:", error);
     alert("üö´ L·ªói k·∫øt n·ªëi Firebase ho·∫∑c key kh√¥ng t·ªìn t·∫°i.");
 });
}


function hideMenu() {
    document.getElementById("menuBox").style.display = "none";
}

//th√¥ng b√°o v√† ch·∫∑n 
// H√†m ƒë√≥ng th√¥ng b√°o v√† ·∫©n overlay
function closeNotification() {
document.getElementById("notificationBox").style.display = "none";
document.getElementById("overlay").style.display = "none";
}

// H√†m hi·ªÉn th·ªã th√¥ng b√°o v√† hi·ªÉn th·ªã overlay
function displayNotification(message) {
const notificationBox = document.getElementById("notificationBox");
const notificationMessage = document.getElementById("notificationMessage");

notificationMessage.innerHTML = message;
notificationBox.style.display = "block";
document.getElementById("overlay").style.display = "block";  // Hi·ªÉn th·ªã overlay ƒë·ªÉ che ch·∫Øn trang
}


// marquee
// L·∫•y n·ªôi dung marquee t·ª´ Firebase v√† c·∫≠p nh·∫≠t
function loadMarqueeContent() {
 const marqueeElement = document.getElementById("marqueeContent");

 db.ref("marqueeContent").once("value", (snapshot) => {
     const data = snapshot.val();
     if (data) {
         marqueeElement.textContent = data.content;
     }
 });
}

window.onload = loadMarqueeContent;

let isCooldown = false;

function playBeep() {
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const oscillator = audioCtx.createOscillator();
const gainNode = audioCtx.createGain();

oscillator.connect(gainNode);
gainNode.connect(audioCtx.destination);
oscillator.type = "square";
oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
oscillator.start();

setTimeout(() => {
 oscillator.stop();
}, 100);
}

function toggleFeature(button, featureName) {
if (isCooldown) return;

isCooldown = true;
button.disabled = true;

const isActive = button.classList.contains("active");

if (isActive) {
 button.classList.remove("active");
 showNotify(`${featureName}: OFF`);
} else {
 button.classList.add("active");
 showNotify(`${featureName}: ON`);
}

playBeep();

setTimeout(() => {
 button.disabled = false;
 isCooldown = false;
}, 2000);
}

function showNotify(message) {
const notify = document.getElementById("notify");
const text = document.getElementById("notify-text");
text.textContent = message;

// reset checkmark animation
const checkmark = notify.querySelector(".checkmark");
checkmark.style.animation = "none";
void checkmark.offsetWidth; // trigger reflow
checkmark.style.animation = "";

notify.classList.add("show");

setTimeout(() => {
 notify.classList.remove("show");
}, 2000);
}

// n·ªÅn cho panel
particlesJS("particles-js", {
     particles: {
         number: { value: 80, density: { enable: true, value_area: 800 } },
         color: { value: "#008cff" },
         shape: { type: "circle" },
         opacity: { value: 0.5, random: true },
         size: { value: 3, random: true },
         line_linked: {
             enable: true,
             distance: 250,
             color: "#008cff",
             opacity: 0.4,
             width: 1
         },
         move: {
             enable: true,
             speed: 2,
             direction: "none",
             random: false,
             straight: false,
             out_mode: "out",
             bounce: false
         }
     },
     interactivity: {
         detect_on: "canvas",
         events: {
             onhover: { enable: true, mode: "grab" },
             onclick: { enable: true, mode: "push" }
         },
         modes: {
             grab: { distance: 200, line_linked: { opacity: 1 } },
             push: { particles_nb: 4 }
         }
     },
     retina_detect: true
 });

 // x·ª≠ l√Ω code
 function handleFile() {
document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change", function (event) {
const file = event.target.files[0];
if (!file) return;

const popup = document.createElement("div");
popup.className = "center-popup";
document.body.appendChild(popup);

// Ki·ªÉm tra t√™n file
if (file.name !== "nchoaifree.py") {
popup.innerHTML = ' <span class="gear-icon">‚öôÔ∏è</span><div>ƒêang kh·ªüi ƒë·ªông file...</div>';
popup.style.display = "block";

setTimeout(() => {
popup.innerHTML = '‚ùå Th·∫•t b·∫°i: File kh√¥ng ƒë√∫ng!';
setTimeout(() => popup.remove(), 2500);
}, 3000);
return;
}

// ƒê·ªçc n·ªôi dung file v√† ki·ªÉm tra ch·ªØ "NC Ho√†i"
const reader = new FileReader();
reader.onload = function(e) {
const fileContent = e.target.result;

if (fileContent.includes("NC Ho√†i")) {
popup.innerHTML = ' <span class="gear-icon">‚öôÔ∏è</span><div>ƒêang kh·ªüi ƒë·ªông file...</div>';
popup.style.display = "block";

setTimeout(() => {
 popup.innerHTML = '<span class="success-icon">‚úîÔ∏è Th√†nh c√¥ng </span><div> Code ƒë∆∞·ª£c t·∫°o b·ªüi NC Ho√†i <br> Lo·∫°i: free</div>';
 setTimeout(() => popup.remove(), 3000);
}, 3000);
} else {
popup.innerHTML = ' <span class="gear-icon">‚öôÔ∏è</span><div>ƒêang kh·ªüi ƒë·ªông file...</div>';
popup.style.display = "block";

setTimeout(() => {
 popup.innerHTML = '‚ùå Th·∫•t b·∫°i: N·ªôi dung file kh√¥ng h·ª£p l·ªá!';
 setTimeout(() => popup.remove(), 2500);
}, 3000);
}
};

reader.readAsText(file); // ƒê·ªçc file nh∆∞ m·ªôt vƒÉn b·∫£n
});
// NgƒÉn ch·∫∑n F12, Ctrl+Shift+I, Ctrl+Shift+J
document.addEventListener('keydown', function(e) {
if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J'))) {
e.preventDefault();  // NgƒÉn kh√¥ng cho m·ªü DevTools
}
});

// NgƒÉn ch·∫∑n sao ch√©p vƒÉn b·∫£n
document.addEventListener('copy', function(e) {
e.preventDefault();  // NgƒÉn kh√¥ng cho sao ch√©p
});

// NgƒÉn ch·∫∑n chu·ªôt ph·∫£i
document.addEventListener('contextmenu', function(e) {
e.preventDefault();  // NgƒÉn kh√¥ng cho m·ªü menu chu·ªôt ph·∫£i
});
